---
import DashboardAdmin from "../../../layouts/dashboard-admin.astro";
import { Button } from "../../../components/ui/button";
import {
  Card,
  CardHeader,
  CardTitle,
  CardContent,
} from "../../../components/ui/card";
---

<DashboardAdmin>
  <div class="p-6 space-y-6">
    <div class="flex items-center justify-between">
      <h1 class="text-2xl font-bold">Edit Mentor</h1>
      <a href="/dashboard/data-mentor">
        <Button variant="outline">Kembali</Button>
      </a>
    </div>

    <Card>
      <CardHeader>
        <CardTitle>Data Mentor</CardTitle>
      </CardHeader>
      <CardContent>
        <form id="mentor-form" class="space-y-6">
          <div class="grid gap-4 md:grid-cols-2">
            <div class="space-y-2">
              <label for="name" class="text-sm font-medium">Nama Lengkap</label>
              <input 
                id="name"
                name="name"
                type="text"
                class="w-full px-3 py-2 border rounded-md"
                required
              />
            </div>

            <div class="space-y-2">
              <label for="position" class="text-sm font-medium">Posisi</label>
              <input 
                id="position"
                name="position"
                type="text"
                class="w-full px-3 py-2 border rounded-md"
                required
              />
            </div>

            <div class="space-y-2">
              <label for="email" class="text-sm font-medium">Email</label>
              <input 
                id="email"
                name="email"
                type="email"
                class="w-full px-3 py-2 border rounded-md"
                required
              />
            </div>

            <div class="space-y-2">
              <label for="phone" class="text-sm font-medium">Nomor Telepon</label>
              <input 
                id="phone"
                name="phone"
                type="tel"
                class="w-full px-3 py-2 border rounded-md"
                required
              />
            </div>

            <div class="space-y-2">
              <label for="location" class="text-sm font-medium">Lokasi</label>
              <input 
                id="location"
                name="location"
                type="text"
                class="w-full px-3 py-2 border rounded-md"
                required
              />
            </div>

            <div class="space-y-2">
              <label for="status" class="text-sm font-medium">Status</label>
              <select 
                id="status"
                name="status"
                class="w-full px-3 py-2 border rounded-md"
                required
              >
                <option value="active">Active</option>
                <option value="inactive">Inactive</option>
              </select>
            </div>
          </div>

          <div class="space-y-2">
            <label for="description" class="text-sm font-medium">Deskripsi</label>
            <textarea 
              id="description"
              name="description"
              rows="4"
              class="w-full px-3 py-2 border rounded-md"
              required
            ></textarea>
          </div>

          <div class="space-y-2">
            <label for="skills" class="text-sm font-medium">Keahlian (pisahkan dengan koma)</label>
            <input 
              id="skills"
              name="skills"
              type="text"
              class="w-full px-3 py-2 border rounded-md"
              placeholder="e.g. Leadership, Mentoring, Public Speaking"
              required
            />
          </div>

          <div class="space-y-2">
            <label for="achievements" class="text-sm font-medium">Pencapaian</label>
            <textarea 
              id="achievements"
              name="achievements"
              rows="4"
              class="w-full px-3 py-2 border rounded-md"
              required
            ></textarea>
          </div>

          <div class="grid gap-4 md:grid-cols-2">
            <div class="space-y-2">
              <label for="studentsHelped" class="text-sm font-medium">Jumlah Siswa yang Dibimbing</label>
              <input 
                id="studentsHelped"
                name="studentsHelped"
                type="number"
                class="w-full px-3 py-2 border rounded-md"
                required
              />
            </div>

            <div class="space-y-2">
              <label for="yearsExperience" class="text-sm font-medium">Pengalaman (tahun)</label>
              <input 
                id="yearsExperience"
                name="yearsExperience"
                type="number"
                class="w-full px-3 py-2 border rounded-md"
                required
              />
            </div>
          </div>

          <div>
            <Button type="submit" variant="default" className="bg-[#406386]">
              Update Data Mentor
            </Button>
          </div>
        </form>
      </CardContent>
    </Card>
  </div>
</DashboardAdmin>

<!-- Hidden template for form -->
<template id="form-template">
  <div class="grid gap-4 md:grid-cols-2">
    <div class="space-y-2">
      <label for="name" class="text-sm font-medium">Nama Lengkap</label>
      <input 
        id="name"
        name="name"
        type="text"
        class="w-full px-3 py-2 border rounded-md"
        required
      />
    </div>

    <div class="space-y-2">
      <label for="position" class="text-sm font-medium">Posisi</label>
      <input 
        id="position"
        name="position"
        type="text"
        class="w-full px-3 py-2 border rounded-md"
        required
      />
    </div>

    <div class="space-y-2">
      <label for="email" class="text-sm font-medium">Email</label>
      <input 
        id="email"
        name="email"
        type="email"
        class="w-full px-3 py-2 border rounded-md"
        required
      />
    </div>

    <div class="space-y-2">
      <label for="phone" class="text-sm font-medium">Nomor Telepon</label>
      <input 
        id="phone"
        name="phone"
        type="tel"
        class="w-full px-3 py-2 border rounded-md"
        required
      />
    </div>

    <div class="space-y-2">
      <label for="location" class="text-sm font-medium">Lokasi</label>
      <input 
        id="location"
        name="location"
        type="text"
        class="w-full px-3 py-2 border rounded-md"
        required
      />
    </div>

    <div class="space-y-2">
      <label for="status" class="text-sm font-medium">Status</label>
      <select 
        id="status"
        name="status"
        class="w-full px-3 py-2 border rounded-md"
        required
      >
        <option value="active">Active</option>
        <option value="inactive">Inactive</option>
      </select>
    </div>
  </div>

  <div class="space-y-2">
    <label for="description" class="text-sm font-medium">Deskripsi</label>
    <textarea 
      id="description"
      name="description"
      rows="4"
      class="w-full px-3 py-2 border rounded-md"
      required
    ></textarea>
  </div>

  <div class="space-y-2">
    <label for="skills" class="text-sm font-medium">Keahlian (pisahkan dengan koma)</label>
    <input 
      id="skills"
      name="skills"
      type="text"
      class="w-full px-3 py-2 border rounded-md"
      placeholder="e.g. Leadership, Mentoring, Public Speaking"
      required
    />
  </div>

  <div class="space-y-2">
    <label for="achievements" class="text-sm font-medium">Pencapaian</label>
    <textarea 
      id="achievements"
      name="achievements"
      rows="4"
      class="w-full px-3 py-2 border rounded-md"
      required
    ></textarea>
  </div>

  <div class="grid gap-4 md:grid-cols-2">
    <div class="space-y-2">
      <label for="studentsHelped" class="text-sm font-medium">Jumlah Siswa yang Dibimbing</label>
      <input 
        id="studentsHelped"
        name="studentsHelped"
        type="number"
        min="0"
        class="w-full px-3 py-2 border rounded-md"
        required
      />
    </div>

    <div class="space-y-2">
      <label for="yearsExperience" class="text-sm font-medium">Pengalaman (tahun)</label>
      <input 
        id="yearsExperience"
        name="yearsExperience"
        type="number"
        min="0"
        max="50"
        class="w-full px-3 py-2 border rounded-md"
        required
      />
    </div>
  </div>

  <div>
    <button type="submit" class="px-4 py-2 font-medium text-white bg-[#406386] rounded-md hover:bg-[#375573]">
      Update Data Mentor
    </button>
  </div>
</template>

<script>
import { MentorService } from '../../../lib/mentor-service';

const getMentorId = () => {
  const path = window.location.pathname;
  const matches = path.match(/\/dashboard\/mentor\/(\d+)\/edit/);
  return matches ? parseInt(matches[1]) : null;
};

const setLoading = (button: HTMLButtonElement, isLoading: boolean) => {
  button.disabled = isLoading;
  button.innerHTML = isLoading ? 'Menyimpan...' : 'Update Data Mentor';
};

const showError = (form: HTMLFormElement, message: string) => {
  const existingError = form.querySelector('.error-message');
  if (existingError) existingError.remove();

  const errorDiv = document.createElement('div');
  errorDiv.className = 'p-4 mb-4 text-sm text-red-700 bg-red-100 rounded-lg error-message';
  errorDiv.textContent = message;
  form.insertBefore(errorDiv, form.firstChild);
  setTimeout(() => errorDiv.remove(), 5000);
};

const validateForm = (data: any) => {
  if (!data.email.includes('@')) {
    throw new Error('Email tidak valid');
  }
  if (data.phone.length < 10 || data.phone.length > 15) {
    throw new Error('Nomor telepon tidak valid');
  }
  if (data.yearsExperience < 0 || data.yearsExperience > 50) {
    throw new Error('Pengalaman harus berada di antara 0 dan 50 tahun');
  }
  if (data.studentsHelped < 0) {
    throw new Error('Jumlah siswa tidak boleh negatif');
  }
  if (data.skills.length === 0) {
    throw new Error('Minimal satu keahlian harus diisi');
  }
};

document.addEventListener('DOMContentLoaded', async () => {
  const mentorId = getMentorId();
  if (!mentorId) {
    alert('Invalid mentor ID');
    window.location.href = '/dashboard/data-mentor';
    return;
  }
  const form = document.getElementById('mentor-form') as HTMLFormElement;
  const submitButton = form.querySelector('button[type="submit"]') as HTMLButtonElement;

  // Show loading state
  form.innerHTML = `
    <div class="flex items-center justify-center p-6">
      <div class="text-center">
        <div class="w-8 h-8 border-4 border-t-[#406386] border-r-transparent border-b-[#406386] border-l-transparent rounded-full animate-spin"></div>
        <p class="mt-2 text-gray-600">Memuat data...</p>
      </div>
    </div>
  `;

  // Fetch mentor data
  try {
    const mentor = await MentorService.getMentorById(mentorId);
    
    // Restore form content
    form.innerHTML = document.getElementById('form-template')?.innerHTML || '';
    
    // Get form elements after restoration
    const nameInput = form.querySelector('#name') as HTMLInputElement;
    const positionInput = form.querySelector('#position') as HTMLInputElement;
    const emailInput = form.querySelector('#email') as HTMLInputElement;
    const phoneInput = form.querySelector('#phone') as HTMLInputElement;
    const locationInput = form.querySelector('#location') as HTMLInputElement;
    const statusSelect = form.querySelector('#status') as HTMLSelectElement;
    const descriptionTextarea = form.querySelector('#description') as HTMLTextAreaElement;
    const skillsInput = form.querySelector('#skills') as HTMLInputElement;
    const achievementsTextarea = form.querySelector('#achievements') as HTMLTextAreaElement;
    const studentsHelpedInput = form.querySelector('#studentsHelped') as HTMLInputElement;
    const yearsExperienceInput = form.querySelector('#yearsExperience') as HTMLInputElement;

    // Populate form
    nameInput.value = mentor.name;
    positionInput.value = mentor.position;
    emailInput.value = mentor.email;
    phoneInput.value = mentor.phone;
    locationInput.value = mentor.location;
    statusSelect.value = mentor.status;
    descriptionTextarea.value = mentor.description;
    skillsInput.value = mentor.skills.join(', ');
    achievementsTextarea.value = mentor.achievements;
    studentsHelpedInput.value = mentor.studentsHelped.toString();
    yearsExperienceInput.value = mentor.yearsExperience.toString();    // Handle form submission
    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      try {
        setLoading(submitButton, true);

        const formData = new FormData(form);
        const mentorData = {
          name: (formData.get('name') as string)?.trim() || '',
          position: (formData.get('position') as string)?.trim() || '',
          description: (formData.get('description') as string)?.trim() || '',
          email: (formData.get('email') as string)?.trim() || '',
          phone: (formData.get('phone') as string)?.trim() || '',
          location: (formData.get('location') as string)?.trim() || '',
          skills: (formData.get('skills') as string)?.split(',').map(s => s.trim()).filter(Boolean) || [],
          achievements: (formData.get('achievements') as string)?.trim() || '',
          studentsHelped: parseInt((formData.get('studentsHelped') as string) || '0'),
          yearsExperience: parseInt((formData.get('yearsExperience') as string) || '0'),
          status: formData.get('status') as 'active' | 'inactive'
        };

        // Validate form data
        validateForm(mentorData);

        // Update mentor data
        await MentorService.updateMentor(mentorId, mentorData);
        
        // Show success message and redirect
        const params = new URLSearchParams({ message: 'Data mentor berhasil diperbarui' });
        window.location.href = `/dashboard/data-mentor?${params.toString()}`;
      } catch (error) {
        const message = error instanceof Error ? error.message : 'Gagal memperbarui data mentor';
        console.error('Failed to update mentor:', error);
        showError(form, message);
        setLoading(submitButton, false);
      }
    });  } catch (error) {
    const message = error instanceof Error ? error.message : 'Gagal memuat data mentor';
    console.error('Failed to load mentor:', error);
    showError(form, message);
    
    // Redirect back after showing error
    setTimeout(() => {
      window.location.href = '/dashboard/data-mentor';
    }, 3000);
  }
});
</script>
