---
import DashboardAdmin from "../../../layouts/dashboard-admin.astro";
import { Button } from "@/components/ui/button";
import {
  Card,
  CardHeader,
  CardTitle,
  CardContent,
} from "@/components/ui/card";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Textarea } from "@/components/ui/textarea";
---

<DashboardAdmin>
  <div class="p-6 space-y-6">
    <div class="flex items-center justify-between">
      <h1 class="text-2xl font-bold">Tambah Konten Baru</h1>
      <a href="/dashboard/content">
        <Button variant="outline">Kembali</Button>
      </a>
    </div>

    <Card>
      <CardHeader>
        <CardTitle>Form Konten</CardTitle>
      </CardHeader>
      <CardContent>
        <form id="contentForm" class="space-y-6">
          <div class="grid gap-6 md:grid-cols-2">
            <div class="space-y-2">
              <Label for="title">Judul</Label>
              <Input id="title" name="title" required />
            </div>

            <div class="space-y-2">
              <Label for="slug">Slug URL</Label>
              <Input id="slug" name="slug" placeholder="auto-generated-from-title" />
              <p class="text-xs text-gray-500">Akan terisi otomatis dari judul</p>
            </div>
          </div>

          <div class="grid gap-6 md:grid-cols-2">
            <div class="space-y-2">
              <Label for="category">Kategori</Label>
              <select id="category" name="category" class="flex w-full h-10 px-3 py-2 border rounded-md border-input bg-background text-sm">
                <option value="artikel">Artikel</option>
                <option value="berita">Berita</option>
                <option value="pengumuman">Pengumuman</option>
                <option value="feature">Feature</option>
              </select>
            </div>

            <div class="space-y-2">
              <Label for="status">Status</Label>
              <select id="status" name="status" class="flex w-full h-10 px-3 py-2 border rounded-md border-input bg-background text-sm">
                <option value="published">Published</option>
                <option value="draft">Draft</option>
              </select>
            </div>
          </div>

          <div class="space-y-2">
            <Label for="featured_image">Featured Image</Label>
            <Input id="featured_image" name="featured_image" type="file" accept="image/*" />
          </div>

          <div class="space-y-2">
            <Label for="content">Konten</Label>
            <div id="editorContainer">
              <textarea id="content" name="content" rows="10" class="flex min-h-20 w-full rounded-md border border-input bg-transparent px-3 py-2 text-sm shadow-sm placeholder:text-muted-foreground"></textarea>
            </div>
          </div>

          <div class="pt-4 border-t">
            <h3 class="text-base font-medium mb-4">SEO Settings</h3>
            <div class="grid gap-6 md:grid-cols-2">
              <div class="space-y-2">
                <Label for="seo_title">SEO Title</Label>
                <Input id="seo_title" name="seo_title" placeholder="Same as content title if empty" />
              </div>

              <div class="space-y-2">
                <Label for="seo_keywords">SEO Keywords</Label>
                <Input id="seo_keywords" name="seo_keywords" placeholder="keyword1, keyword2, keyword3" />
              </div>
            </div>

            <div class="space-y-2 mt-4">
              <Label for="seo_description">SEO Description</Label>
              <Textarea
                id="seo_description"
                name="seo_description"
                placeholder="Brief description for search engines"
                rows={3}
              />
            </div>
          </div>

          <div class="flex justify-end space-x-4">
            <a href="/dashboard/content">
              <Button type="button" variant="outline">Cancel</Button>
            </a>
            <Button type="submit" className="bg-[#406386]">Save Content</Button>
          </div>
        </form>
      </CardContent>
    </Card>
  </div>
</DashboardAdmin>

<script>
  import { ContentService } from '../../lib/content-service';
  
  // Auto-generate slug from title
  document.getElementById('title')?.addEventListener('input', (e) => {
    const target = e.target as HTMLInputElement;
    const slug = document.getElementById('slug') as HTMLInputElement;
    
    if (!slug.value || slug.dataset.autogenerated === 'true') {
      const slugValue = target.value
        .toLowerCase()
        .replace(/[^\w\s]/gi, '')
        .replace(/\s+/g, '-');
      
      slug.value = slugValue;
      slug.dataset.autogenerated = 'true';
    }
  });
  
  document.getElementById('slug')?.addEventListener('input', (e) => {
    const target = e.target as HTMLInputElement;
    target.dataset.autogenerated = 'false';
  });
  
  // Form submission
  document.getElementById('contentForm')?.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    try {
      const formData = new FormData(e.target as HTMLFormElement);
      
      // Set author_id from localStorage (assuming user is logged in)
      const userData = JSON.parse(localStorage.getItem('bersekolah_user') || '{}');
      formData.append('author_id', userData.id || '1'); // Default to 1 if not found
      
      await ContentService.createContent(formData);
      
      alert('Content created successfully!');
      window.location.href = '/dashboard/content';
    } catch (error) {
      console.error('Failed to create content:', error);
      alert('Failed to create content. Please try again.');
    }
  });
</script>

<style>
  /* Optional: Add some editor styling */
  #editorContainer {
    margin-bottom: 20px;
  }
</style>
